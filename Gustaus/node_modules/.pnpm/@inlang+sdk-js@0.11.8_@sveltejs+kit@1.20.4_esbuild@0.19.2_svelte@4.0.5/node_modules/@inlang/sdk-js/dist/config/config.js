import { setupConfig } from "@inlang/core/config";
import { initialize$import } from "@inlang/core/environment";
import { dedent } from "ts-dedent";
import { InlangSdkException } from "../adapter-sveltekit/vite-plugin/exceptions.js";
export const initInlangEnvironment = async () => {
    const fs = await import("node:fs/promises").catch(() => new Proxy({}, {
        get: (target, key) => {
            if (key === "then")
                return Promise.resolve(target);
            return () => {
                throw new InlangSdkException("`node:fs/promises` is not available in the current environment");
            };
        },
    }));
    return {
        $fs: fs,
        $import: initialize$import({
            fs,
            fetch: async (...args) => await fetch(...args).catch((error) => {
                // TODO: create an issue
                if (error instanceof TypeError &&
                    error.cause?.code === "UND_ERR_CONNECT_TIMEOUT") {
                    throw new InlangSdkException(dedent `
								Node.js failed to resolve the URL. This can happen sometimes during development.
								Usually restarting the server helps.
							`, error);
                }
                throw new InlangSdkException(`Failed to fetch from (${args[0]})`, error);
            }),
        }),
    };
};
export const initConfig = async (module) => {
    if (!module) {
        throw new InlangSdkException("could not read `inlang.config.js`");
    }
    const env = await initInlangEnvironment();
    return setupConfig({ module, env });
};
