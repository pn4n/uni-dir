"use strict";var b=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var A=(e,t)=>{for(var o in t)b(e,o,{get:t[o],enumerable:!0})},E=(e,t,o,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of P(t))!F.call(e,s)&&s!==o&&b(e,s,{get:()=>t[s],enumerable:!(a=g(t,s))||a.enumerable});return e};var I=e=>E(b({},"__esModule",{value:!0}),e);var v={};A(v,{authentication:()=>w,memoryStorage:()=>j,staticToken:()=>k});module.exports=I(v);var h=async(e,t,o)=>{t.headers=typeof t.headers=="object"&&!Array.isArray(t.headers)?t.headers:{};let s=o??(r=>typeof r=="object"&&r&&"data"in r?r.data:r),m=await globalThis.fetch(e,t).then(async r=>{let i=r.headers.get("Content-Type")?.toLowerCase();if(i?.startsWith("application/json")){let c=await r.json();if(!r.ok)throw c;return c}if(i?.startsWith("text/html")||i?.startsWith("text/plain")){let c=await r.text();if(!r.ok)throw c;return c}}).catch(r=>{throw r});return s(m)};var O=e=>{let t={};if(Array.isArray(e.fields)&&e.fields.length>0){let o=(a,s=[])=>{if(typeof a=="object"){let m=[];for(let r in a){let i=a[r]??[];if(Array.isArray(i))for(let c of i)m.push(o(c,[...s,r]));else if(typeof i=="object")for(let c of Object.keys(i)){let S=i[c];for(let f of S)m.push(o(f,[...s,`${r}:${c}`]))}}return m.flatMap(r=>r)}return[...s,String(a)].join(".")};t.fields=e.fields.flatMap(a=>o(a)).join(",")}return e.filter&&Object.keys(e.filter).length>0&&(t.filter=JSON.stringify(e.filter)),e.search&&(t.search=e.search),"sort"in e&&e.sort&&(t.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(t.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(t.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(t.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(t.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(t.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(t.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(t.groupBy=e.groupBy.join(",")),t};var x="/",N=(e,t)=>(e.endsWith(x)&&(e=e.slice(0,-1)),t.startsWith(x)||(t=x+t),e+t),u=(e,t,o)=>{let a=e.pathname===x?t:N(e.pathname,t),s=new globalThis.URL(a,e);if(o)for(let[m,r]of Object.entries(O(o)))if(r&&typeof r=="object"&&!Array.isArray(r))for(let[i,c]of Object.entries(r))s.searchParams.set(`${m}[${i}]`,String(c));else s.searchParams.set(m,r);return s};var j=()=>{let e=null;return{get:async()=>e,set:async t=>{e=t}}};var C={msRefreshBeforeExpires:3e4,autoRefresh:!0},w=(e="cookie",t={})=>o=>{t={...C,...t};let a=null,s=null,m=t.storage??j(),r="autoRefresh"in t?t.autoRefresh:C.autoRefresh,i=typeof t.msRefreshBeforeExpires=="number"?t.msRefreshBeforeExpires:C.msRefreshBeforeExpires,c=()=>{m.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},S=async()=>{try{await a}finally{a=null}},f=async()=>{let n=await m.get();if(a||!n?.expires_at){await S();return}n.expires_at<new Date().getTime()+i&&Q().catch(p=>{}),await S()},R=n=>{let p=n.expires??0;n.expires_at=new Date().getTime()+p,m.set(n),r&&p>i&&p<Number.MAX_SAFE_INTEGER&&(s&&clearTimeout(s),s=setTimeout(()=>{s=null,Q().catch(d=>{})},p-i))},Q=async()=>(a=(async()=>{let p=await m.get();c();let d={method:"POST",headers:{"Content-Type":"application/json"}};e==="json"&&p?.refresh_token&&(d.body=JSON.stringify({refresh_token:p.refresh_token}));let T=u(o.url,"/auth/refresh"),l=await h(T.toString(),d).catch(y=>{throw y});return R(l),l})().catch(p=>{throw p}),a);return{refresh:Q,async login(n,p,d={}){c();let T=d.provider?`/auth/login/${d.provider}`:"/auth/login",l=u(o.url,T),y={email:n,password:p};"otp"in d&&(y.otp=d.otp),"mode"in d&&(y.mode=d.mode);let D=await h(l.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});return R(D),D},async logout(){let n=await m.get(),p={method:"POST",headers:{"Content-Type":"application/json"}};e==="json"&&n?.refresh_token&&(p.body=JSON.stringify({refresh_token:n.refresh_token}));let d=u(o.url,"/auth/logout");await h(d.toString(),p,null),s&&clearTimeout(s),c()},async getToken(){return await f(),(await m.get())?.access_token??null},setToken(n){m.set({access_token:n,refresh_token:null,expires:null,expires_at:null})}}};var k=e=>t=>{let o=e??null;return{async getToken(){return o},setToken(a){o=a}}};0&&(module.exports={authentication,memoryStorage,staticToken});
//# sourceMappingURL=index.cjs.map