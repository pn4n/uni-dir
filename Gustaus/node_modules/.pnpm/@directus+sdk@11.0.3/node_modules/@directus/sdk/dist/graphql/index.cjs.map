{"version":3,"sources":["../../src/graphql/index.ts","../../src/utils/request.ts","../../src/rest/utils/query-to-params.ts","../../src/utils/get-request-url.ts","../../src/graphql/composable.ts"],"sourcesContent":["export * from './composable.js';\nexport type * from './types.js';\n","/**\n * Request helper providing default settings\n *\n * @param url The request URL\n * @param options The request options\n *\n * @returns The API result if successful\n */\nexport const request = async <Output = any>(\n\turl: string,\n\toptions: RequestInit,\n\tformatter?: ((data: any) => Output) | null\n): Promise<Output> => {\n\toptions.headers =\n\t\ttypeof options.headers === 'object' && !Array.isArray(options.headers)\n\t\t\t? (options.headers as Record<string, string>)\n\t\t\t: {};\n\n\tconst defaultFormatter = (data: Output | { data: Output }) => {\n\t\tif (typeof data === 'object' && data && 'data' in data) {\n\t\t\treturn data.data;\n\t\t}\n\n\t\treturn data;\n\t};\n\n\tconst outputFormatter = formatter !== undefined && formatter !== null ? formatter : defaultFormatter;\n\n\tconst response = await globalThis\n\t\t.fetch(url, options)\n\t\t.then(async (response) => {\n\t\t\tconst type = response.headers.get('Content-Type')?.toLowerCase();\n\n\t\t\tif (type?.startsWith('application/json')) {\n\t\t\t\tconst result = await response.json();\n\t\t\t\tif (!response.ok) throw result;\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\tif (type?.startsWith('text/html') || type?.startsWith('text/plain')) {\n\t\t\t\tconst result = await response.text();\n\t\t\t\tif (!response.ok) throw result;\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\t// empty body fallback\n\t\t\treturn;\n\t\t})\n\t\t.catch((err) => {\n\t\t\tthrow err;\n\t\t});\n\n\treturn outputFormatter(response);\n};\n","import type { AggregationTypes, GroupByFields, Query } from '../../types/index.js';\n\ntype ExtendedQuery<Schema extends object, Item> = Query<Schema, Item> & {\n\taggregate?: Record<keyof AggregationTypes, string>;\n\tgroupBy?: (string | GroupByFields<Schema, Item>)[];\n};\n\n/**\n * Transform nested query object to an url compatible format\n *\n * @param query The nested query object\n *\n * @returns Flat query parameters\n */\nexport const queryToParams = <Schema extends object, Item>(\n\tquery: ExtendedQuery<Schema, Item>\n): Record<string, string> => {\n\tconst params: Record<string, string> = {};\n\n\tif (Array.isArray(query.fields) && query.fields.length > 0) {\n\t\ttype FieldItem = (typeof query.fields)[number];\n\n\t\tconst walkFields = (value: FieldItem, chain: string[] = []): string | string[] => {\n\t\t\tif (typeof value === 'object') {\n\t\t\t\tconst result = [];\n\n\t\t\t\tfor (const key in value) {\n\t\t\t\t\tconst nestedField = value[key as keyof typeof value] ?? [];\n\n\t\t\t\t\tif (Array.isArray(nestedField)) {\n\t\t\t\t\t\t// regular nested fields\n\t\t\t\t\t\tfor (const item of nestedField) {\n\t\t\t\t\t\t\tresult.push(walkFields(item as FieldItem, [...chain, key]));\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (typeof nestedField === 'object') {\n\t\t\t\t\t\t// many to any nested\n\t\t\t\t\t\tfor (const scope of Object.keys(nestedField)) {\n\t\t\t\t\t\t\tconst fields = (nestedField as Record<string, FieldItem[]>)[scope]!;\n\n\t\t\t\t\t\t\tfor (const item of fields) {\n\t\t\t\t\t\t\t\tresult.push(walkFields(item as FieldItem, [...chain, `${key}:${scope}`]));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn result.flatMap((items) => items);\n\t\t\t}\n\n\t\t\treturn [...chain, String(value)].join('.');\n\t\t};\n\n\t\tparams['fields'] = query.fields.flatMap((value) => walkFields(value)).join(',');\n\t}\n\n\tif (query.filter && Object.keys(query.filter).length > 0) {\n\t\tparams['filter'] = JSON.stringify(query.filter);\n\t}\n\n\tif (query.search) {\n\t\t// covers both empty string and undefined\n\t\tparams['search'] = query.search;\n\t}\n\n\tif ('sort' in query && query.sort) {\n\t\t// covers empty array and undefined\n\t\tparams['sort'] = typeof query.sort === 'string' ? query.sort : query.sort.join(',');\n\t}\n\n\tif (typeof query.limit === 'number' && query.limit >= -1) {\n\t\tparams['limit'] = String(query.limit);\n\t}\n\n\tif (typeof query.offset === 'number' && query.offset >= 0) {\n\t\tparams['offset'] = String(query.offset);\n\t}\n\n\tif (typeof query.page === 'number' && query.page >= 1) {\n\t\tparams['page'] = String(query.page);\n\t}\n\n\tif (query.deep && Object.keys(query.deep).length > 0) {\n\t\tparams['deep'] = JSON.stringify(query.deep);\n\t}\n\n\tif (query.alias && Object.keys(query.alias).length > 0) {\n\t\tparams['alias'] = JSON.stringify(query.alias);\n\t}\n\n\tif (query.aggregate && Object.keys(query.aggregate).length > 0) {\n\t\tparams['aggregate'] = JSON.stringify(query.aggregate);\n\t}\n\n\tif (query.groupBy && query.groupBy.length > 0) {\n\t\tparams['groupBy'] = query.groupBy.join(',');\n\t}\n\n\treturn params;\n};\n","import { queryToParams } from '../index.js';\n\nconst SEPARATOR = '/';\n\nconst mergePaths = (a: string, b: string) => {\n\tif (a.endsWith(SEPARATOR)) a = a.slice(0, -1);\n\tif (!b.startsWith(SEPARATOR)) b = SEPARATOR + b;\n\treturn a + b;\n};\n\n/**\n * Build URL based on provided options\n *\n * @param baseUrl The base URL\n * @param options The request options\n *\n * @returns URL\n */\nexport const getRequestUrl = (baseUrl: URL, path: string, params?: Record<string, any>): URL => {\n\tconst newPath = baseUrl.pathname === SEPARATOR ? path : mergePaths(baseUrl.pathname, path);\n\tconst url = new globalThis.URL(newPath, baseUrl);\n\n\tif (params) {\n\t\tfor (const [k, v] of Object.entries(queryToParams(params))) {\n\t\t\tif (v && typeof v === 'object' && !Array.isArray(v)) {\n\t\t\t\tfor (const [k2, v2] of Object.entries(v)) {\n\t\t\t\t\turl.searchParams.set(`${k}[${k2}]`, String(v2));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\turl.searchParams.set(k, v);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn url;\n};\n","import type { DirectusClient } from '../types/client.js';\nimport type { GraphqlClient } from './types.js';\nimport { request } from '../utils/request.js';\nimport { getRequestUrl } from '../utils/get-request-url.js';\nimport type { AuthenticationClient } from '../auth/types.js';\n\n/**\n * Creates a client to communicate with Directus GraphQL.\n *\n * @returns A Directus GraphQL client.\n */\nexport const graphql = () => {\n\treturn <Schema extends object>(client: DirectusClient<Schema>): GraphqlClient<Schema> => {\n\t\treturn {\n\t\t\tasync query<Output extends object = Record<string, any>>(\n\t\t\t\tquery: string,\n\t\t\t\tvariables?: Record<string, unknown>,\n\t\t\t\tscope: 'items' | 'system' = 'items'\n\t\t\t): Promise<Output> {\n\t\t\t\tconst options: RequestInit = {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tbody: JSON.stringify({ query, variables }),\n\t\t\t\t};\n\n\t\t\t\tconst headers: Record<string, string> = {};\n\n\t\t\t\tif ('getToken' in this) {\n\t\t\t\t\tconst token = await (this.getToken as AuthenticationClient<Schema>['getToken'])();\n\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders['Authorization'] = `Bearer ${token}`;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ('Content-Type' in headers === false) {\n\t\t\t\t\theaders['Content-Type'] = 'application/json';\n\t\t\t\t}\n\n\t\t\t\toptions.headers = headers;\n\t\t\t\tconst requestPath = scope === 'items' ? '/graphql' : '/graphql/system';\n\t\t\t\tconst requestUrl = getRequestUrl(client.url, requestPath);\n\n\t\t\t\treturn await request<Output>(requestUrl.toString(), options);\n\t\t\t},\n\t\t};\n\t};\n};\n"],"mappings":"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","names":["graphql_exports","__export","graphql","__toCommonJS","request","url","options","formatter","outputFormatter","data","response","type","result","err","queryToParams","query","params","walkFields","value","chain","result","key","nestedField","item","scope","fields","items","SEPARATOR","mergePaths","a","b","getRequestUrl","baseUrl","path","params","newPath","url","k","v","queryToParams","k2","v2","graphql","client","query","variables","scope","options","headers","token","requestPath","requestUrl","getRequestUrl","request"]}