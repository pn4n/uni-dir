"use strict";var k=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var N=(t,o)=>{for(var n in o)k(t,n,{get:o[n],enumerable:!0})},T=(t,o,n,d)=>{if(o&&typeof o=="object"||typeof o=="function")for(let c of A(o))!L.call(t,c)&&c!==n&&k(t,c,{get:()=>o[c],enumerable:!(d=O(o,c))||d.enumerable});return t};var R=t=>T(k({},"__esModule",{value:!0}),t);var H={};N(H,{auth:()=>f,generateUid:()=>m,messageCallback:()=>b,pong:()=>E,realtime:()=>M,sleep:()=>w});module.exports=R(H);function f(t){return JSON.stringify({...t,type:"auth"})}var E=()=>JSON.stringify({type:"pong"});var b=t=>new Promise((o,n)=>{let d=c=>{try{let u=JSON.parse(c.data);typeof u=="object"&&!Array.isArray(u)&&u!==null&&(t.removeEventListener("message",d),o(u))}catch{t.removeEventListener("message",d),o(c)}};t.addEventListener("message",d),t.addEventListener("error",()=>n()),t.addEventListener("close",()=>n())});function*m(){let t=1;for(;;)yield String(t),t++}var P={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}};function M(t={}){return o=>{t={...P,...t};let n=null,d=m(),c=0,u=!1,y=e=>"getToken"in e,g=async(e,r)=>{if(t.authMode==="strict"&&y(r)){let i=await r.getToken();i&&e.searchParams.set("access_token",i)}return e},C=async e=>{if("url"in t)return await g(new URL(t.url),e);if(["ws:","wss:"].includes(o.url.protocol))return await g(o.url,e);let r=new URL(o.url.toString());return r.protocol=o.url.protocol==="https:"?"wss:":"ws:",r.pathname="/websocket",await g(r,e)},W=()=>{n=null,d=m()};function v(){t.reconnect&&!u&&c<t.reconnect.retries?(u=!0,setTimeout(()=>{c+=1,this.connect().then(()=>{c=0,u=!1}).catch(()=>{})},Math.max(1,t.reconnect.delay))):u=!1}let h={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},x=async(e,r)=>{for(;e.readyState!==WebSocket.CLOSED;){let i=await b(e).catch(()=>{});if(i){if("type"in i){if(i.type==="auth"&&y(r)){let a=await r.getToken();if(a){e.send(f({access_token:a}));continue}}if(t.heartbeat&&i.type==="ping"){e.send(E());continue}}h.message.forEach(a=>a.call(e,i))}}};return{async connect(){let e=this,r=await C(e);return new Promise((i,a)=>{let p=!1,l=new globalThis.WebSocket(r);l.addEventListener("open",async s=>{if(t.authMode==="handshake"&&y(e)){let S=await e.getToken();S&&l.send(f({access_token:S}))}p=!0,h.open.forEach(S=>S.call(l,s)),x(l,e),i()}),l.addEventListener("error",s=>{h.error.forEach(S=>S.call(l,s)),W(),v.call(this),p||a(s)}),l.addEventListener("close",s=>{h.close.forEach(S=>S.call(l,s)),W(),v.call(this),p||a(s)}),n=l})},disconnect(){n&&n?.readyState===WebSocket.OPEN&&n.close(),n=null},onWebSocket(e,r){if(e==="message"){let i=function(a){if(typeof a.data!="string")return r.call(this,a);try{return r.call(this,JSON.parse(a.data))}catch{return r.call(this,a)}};return h[e].add(i),()=>h[e].delete(i)}return h[e].add(r),()=>h[e].delete(r)},sendMessage(e){if(!n||n?.readyState!==WebSocket.OPEN)throw new Error("websocket connection not OPEN");if(typeof e=="string"){n.send(e);return}"uid"in e||(e.uid=d.next().value),n?.send(JSON.stringify(e))},async subscribe(e,r={}){(!n||n.readyState!==WebSocket.OPEN)&&await this.connect(),"uid"in r||(r.uid=d.next().value);let i=!0,a=n,p=s=>a.send(JSON.stringify(s));p({...r,collection:e,type:"subscribe"});async function*l(){for(;i&&n&&n.readyState===WebSocket.OPEN;){let s=await b(n).catch(()=>{});if(s){if("type"in s&&"status"in s&&s.type==="subscribe"&&s.status==="error")throw s;"type"in s&&"uid"in s&&s.type==="subscription"&&s.uid===r.uid&&(yield s)}}if(t.reconnect&&u){for(;u;)await w(10);n&&n.readyState===WebSocket.OPEN&&(n.send(JSON.stringify({...r,collection:e,type:"subscribe"})),yield*l())}}return{subscription:l(),unsubscribe(){p({uid:r.uid,type:"unsubscribe"}),i=!1}}}}}}var w=t=>new Promise(o=>setTimeout(()=>o(),t));0&&(module.exports={auth,generateUid,messageCallback,pong,realtime,sleep});
//# sourceMappingURL=index.cjs.map